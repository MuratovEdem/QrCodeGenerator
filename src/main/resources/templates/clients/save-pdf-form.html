<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Загрузка PDF файла</title>
    <!-- Bootstrap для стилей -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .upload-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border: 2px dashed #007bff;
            border-radius: 10px;
            text-align: center;
            background-color: #f8f9fa;
        }
        .file-input-container {
            margin: 20px 0;
        }
        .file-name {
            margin-top: 10px;
            font-style: italic;
            color: #6c757d;
        }
        .error-message {
            color: #dc3545;
            margin-top: 10px;
        }
        .success-message {
            color: #28a745;
            margin-top: 10px;
        }
        .page-count-info {
            background-color: #e9ecef;
            border-left: 4px solid #007bff;
            padding: 10px;
            margin: 15px 0;
            text-align: left;
            font-size: 0.9rem;
        }
        .page-count-info ul {
            margin-bottom: 0;
            padding-left: 20px;
        }
        .page-count-info li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="upload-container">
        <h2>Загрузка PDF файла</h2>

        <!-- Отображение сообщений -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Форма загрузки файла -->
        <form th:action="@{analyze-pdf}" method="post" enctype="multipart/form-data" id="uploadForm">
            <!-- CSRF токен для безопасности -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <div class="file-input-container">
                <label for="pdfFile" class="form-label fw-bold">Выберите PDF файл:</label>
                <input type="file"
                       class="form-control"
                       id="pdfFile"
                       name="pdfFile"
                       accept=".pdf"
                       required
                       onchange="displayFileName()">
                <div id="fileName" class="file-name"></div>
                <div class="form-text">Поддерживаются только PDF файлы</div>
            </div>

            <!-- Поле для количества страниц в протоколе -->
            <div class="mb-4">
                <label for="protocolSize" class="form-label fw-bold">
                    Количество страниц в одном протоколе:
                </label>
                <div class="input-group">
                    <input type="number"
                           class="form-control"
                           id="protocolSize"
                           name="protocolSize"
                           min="0"
                           max="100"
                           value="0"
                           required
                           onchange="validatePageCount()">
                    <span class="input-group-text">страниц</span>
                </div>
                <div class="form-text">
                    Укажите, сколько страниц составляет один полный протокол
                </div>
                <div id="pageCountError" class="error-message" style="display: none;">
                    Количество страниц должно быть от 0 до 100
                </div>
            </div>

            <!-- Информация о загрузке -->
            <div class="page-count-info">
                <strong>Как это работает:</strong>
                <ul>
                    <li>Файл будет автоматически разделен на отдельные протоколы</li>
                    <li>Каждый протокол будет содержать указанное количество страниц</li>
                    <li>Например: если указать 2 страницы, то из файла на 10 страниц получится 5 протоколов</li>
                    <li>Номера протоколов будут извлечены автоматически из текста</li>
                </ul>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary btn-lg w-100" id="submitBtn">
                    <i class="fas fa-save"></i> Загрузить и обработать
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- FontAwesome для иконок -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<script>
    // Отображение имени выбранного файла
    function displayFileName() {
        const fileInput = document.getElementById('pdfFile');
        const fileNameDisplay = document.getElementById('fileName');

        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const fileSize = (file.size / (1024 * 1024)).toFixed(2); // Размер в МБ

            fileNameDisplay.textContent = `Выбран файл: ${file.name} (${fileSize} МБ)`;

            // Проверка типа файла
            if (!file.type.includes('pdf') && !file.name.toLowerCase().endsWith('.pdf')) {
                alert('Пожалуйста, выберите PDF файл!');
                fileInput.value = '';
                fileNameDisplay.textContent = '';
            }
        } else {
            fileNameDisplay.textContent = '';
        }
    }

    // Валидация количества страниц
    function validatePageCount() {
        const pageCountInput = document.getElementById('protocolSize');
        const errorDiv = document.getElementById('pageCountError');
        const value = parseInt(pageCountInput.value);

        if (value < 0 || value > 100 || isNaN(value)) {
            errorDiv.style.display = 'block';
            pageCountInput.classList.add('is-invalid');
            return false;
        } else {
            errorDiv.style.display = 'none';
            pageCountInput.classList.remove('is-invalid');
            return true;
        }
    }

    // Валидация перед отправкой
    document.getElementById('uploadForm').addEventListener('submit', function(event) {
        const fileInput = document.getElementById('pdfFile');
        const pageCountInput = document.getElementById('protocolSize');

        // Проверка файла
        if (!fileInput.files.length) {
            alert('Пожалуйста, выберите файл для загрузки!');
            event.preventDefault();
            return;
        }

        // Проверка количества страниц
        if (!validatePageCount()) {
            alert('Пожалуйста, укажите корректное количество страниц (от 1 до 100)');
            event.preventDefault();
            return;
        }

        // Дополнительная проверка размера файла
        const file = fileInput.files[0];
        const maxSize = 50 * 1024 * 1024; // 50 MB

        if (file.size > maxSize) {
            alert('Файл слишком большой! Максимальный размер: 50 МБ');
            event.preventDefault();
            return;
        }

        // Показываем индикатор загрузки
        const submitButton = document.getElementById('submitBtn');
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Обработка...';
        submitButton.disabled = true;

        // Добавляем обработку закрытия окна
        window.onbeforeunload = function() {
            return 'Файл все еще загружается. Вы уверены, что хотите покинуть страницу?';
        };
    });

    // Автоматическая валидация при изменении
    document.getElementById('protocolSize').addEventListener('input', validatePageCount);
</script>
</body>
</html>