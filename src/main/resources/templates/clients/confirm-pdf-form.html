<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Протоколы для подтверждения</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .actions {
            white-space: nowrap;
        }
        .edit-input {
            width: 100%;
            padding: 4px;
            box-sizing: border-box;
        }
        .buttons-container {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .error {
            color: red;
            font-size: 12px;
            display: none;
        }
        .uneditable {
            background-color: #f9f9f9;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
    </style>
</head>

<!--TODO сделать проверку на дубликаты номера без отправки на сервер-->
<!--TODO добавить название файла-->
<body>
<h2>Протоколы для подтверждения</h2>

<div th:if="${#lists.isEmpty(protocols)}">
    <p>Нет протоколов для отображения</p>
</div>

<div th:unless="${#lists.isEmpty(protocols)}">
    <table id="protocolsTable">
        <thead>
        <tr>
            <th>Номер протокола</th>
            <th>Дата выпуска</th>
            <th>Файл</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="protocol, stat : ${protocols}" th:id="'protocol-row-' + ${stat.index}">
            <td>
                <!-- Отображение номера протокола -->
                <span th:id="'protocol-number-display-' + ${stat.index}"
                      class="uneditable"
                      th:text="${protocol.number}">
                </span>
                <input type="hidden"
                       th:id="'protocol-number-original-' + ${stat.index}"
                       th:value="${protocol.number}" />
                <input type="text"
                       th:id="'protocol-number-edit-' + ${stat.index}"
                       th:value="${protocol.number}"
                       class="edit-input"
                       style="display: none;"
                       maxlength="50" />
                <div th:id="'protocol-number-error-' + ${stat.index}"
                     class="error">
                    Номер не может быть пустым
                </div>
            </td>
            <td>
                <!-- Отображение даты -->
                <span th:id="'protocol-date-display-' + ${stat.index}"
                      class="uneditable"
                      th:text="${protocol.issueDate}">
                </span>
                <input type="hidden"
                       th:id="'protocol-date-original-' + ${stat.index}"
                       th:value="${protocol.issueDate}" />
                <input type="text"
                       th:id="'protocol-date-edit-' + ${stat.index}"
                       th:value="${protocol.issueDate}"
                       class="edit-input"
                       style="display: none;"
                       placeholder="дд.мм.гггг"
                       pattern="\d{2}\.\d{2}\.\d{4}" />
                <div th:id="'protocol-date-error-' + ${stat.index}"
                     class="error">
                    Дата должна быть в формате дд.мм.гггг
                </div>
            </td>
            <td>
                <!-- Отображение файла (если есть) -->
                <span th:if="${protocol.fileName != null and protocol.fileName != ''}"
                      class="uneditable">
                    <a th:href="@{/protocols/temp/{filename}(filename=${protocol.fileName})}"
                       target="_blank"
                       th:text="${protocol.fileName}">
                    </a>
                </span>
                <span th:if="${protocol.fileName == null or protocol.fileName == ''}"
                      class="uneditable">
                    Нет файла
                </span>
                <input type="hidden"
                       name="protocolFileName"
                       th:value="${protocol.fileName}" />
            </td>
            <td class="actions">
                <!-- Кнопка редактирования -->
                <button type="button"
                        th:id="'protocol-edit-btn-' + ${stat.index}"
                        th:data-index="${stat.index}"
                        onclick="enableEdit(this)">
                    Изменить
                </button>

                <!-- Кнопки сохранения/отмены редактирования (скрыты по умолчанию) -->
                <button type="button"
                        th:id="'protocol-save-btn-' + ${stat.index}"
                        th:data-index="${stat.index}"
                        onclick="saveEdit(this)"
                        style="display: none;">
                    Сохранить
                </button>
                <button type="button"
                        th:id="'protocol-cancel-btn-' + ${stat.index}"
                        th:data-index="${stat.index}"
                        onclick="cancelEdit(this)"
                        style="display: none;">
                    Отмена
                </button>

                <!-- Кнопка удаления -->
                <button type="button"
                        th:id="'protocol-delete-btn-' + ${stat.index}"
                        th:data-index="${stat.index}"
                        onclick="deleteProtocol(this)">
                    Удалить
                </button>

                <!-- Кнопка просмотра файла -->
                <button type="button"
                        th:id="'protocol-view-btn-' + ${stat.index}"
                        th:data-index="${stat.index}"
                        th:data-filename="${protocol.fileName}"
                        onclick="viewFile(this)"
                        th:disabled="${protocol.fileName == null or protocol.fileName == ''}">
                    Просмотреть файл
                </button>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- Основные кнопки действий -->
    <div class="buttons-container">
        <form id="confirmForm"
              th:action="@{/clients/{clientId}/confirm-pdf(clientId=${clientId})}"
              method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <!-- Скрытые поля будут заполнены JavaScript -->
            <button type="submit" onclick="prepareConfirmForm(event)">Сохранить все</button>
        </form>

        <form id="cancelForm"
              th:action="@{/clients/{clientId}/cancel-pdf(clientId=${clientId})}"
              method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <!-- Скрытые поля будут заполнены JavaScript -->
            <button type="submit" onclick="prepareCancelForm(event)">Отменить</button>
        </form>
    </div>
</div>

<script>
    // Массив для хранения измененных протоколов
    let protocolsData = [];

    // Инициализация данных при загрузке
    document.addEventListener('DOMContentLoaded', function() {
        const protocolRows = document.querySelectorAll('[id^="protocol-row-"]');
        protocolRows.forEach(row => {
            const index = row.id.split('-')[2];
            protocolsData[index] = {
                number: document.getElementById(`protocol-number-original-${index}`).value,
                date: document.getElementById(`protocol-date-original-${index}`).value,
                fileName: row.querySelector('input[name="protocolFileName"]').value,
                deleted: false
            };
        });
    });

    // Включение режима редактирования
    function enableEdit(button) {
        const index = button.getAttribute('data-index');

        // Показываем поля ввода
        document.getElementById(`protocol-number-display-${index}`).style.display = 'none';
        document.getElementById(`protocol-number-edit-${index}`).style.display = 'block';
        document.getElementById(`protocol-date-display-${index}`).style.display = 'none';
        document.getElementById(`protocol-date-edit-${index}`).style.display = 'block';

        // Меняем кнопки
        document.getElementById(`protocol-edit-btn-${index}`).style.display = 'none';
        document.getElementById(`protocol-save-btn-${index}`).style.display = 'inline';
        document.getElementById(`protocol-cancel-btn-${index}`).style.display = 'inline';
    }

    // Сохранение изменений
    function saveEdit(button) {
        const index = button.getAttribute('data-index');

        // Получаем значения из полей ввода
        const newNumber = document.getElementById(`protocol-number-edit-${index}`).value.trim();
        const newDate = document.getElementById(`protocol-date-edit-${index}`).value.trim();

        // Валидация
        let isValid = true;

        if (!newNumber) {
            document.getElementById(`protocol-number-error-${index}`).style.display = 'block';
            isValid = false;
        } else {
            document.getElementById(`protocol-number-error-${index}`).style.display = 'none';
        }

        if (!newDate || !isValidDate(newDate)) {
            document.getElementById(`protocol-date-error-${index}`).style.display = 'block';
            isValid = false;
        } else {
            document.getElementById(`protocol-date-error-${index}`).style.display = 'none';
        }

        if (!isValid) {
            return;
        }

        // Обновляем отображаемые значения
        document.getElementById(`protocol-number-display-${index}`).textContent = newNumber;
        document.getElementById(`protocol-date-display-${index}`).textContent = newDate;

        // Обновляем данные в массиве
        if (protocolsData[index]) {
            protocolsData[index].number = newNumber;
            protocolsData[index].date = newDate;
        }

        // Возвращаем режим просмотра
        cancelEdit(button);
    }

    // Отмена редактирования
    function cancelEdit(button) {
        const index = button.getAttribute('data-index');

        // Восстанавливаем исходные значения
        document.getElementById(`protocol-number-edit-${index}`).value =
            protocolsData[index]?.number ||
            document.getElementById(`protocol-number-original-${index}`).value;
        document.getElementById(`protocol-date-edit-${index}`).value =
            protocolsData[index]?.date ||
            document.getElementById(`protocol-date-original-${index}`).value;

        // Скрываем поля ввода
        document.getElementById(`protocol-number-display-${index}`).style.display = 'block';
        document.getElementById(`protocol-number-edit-${index}`).style.display = 'none';
        document.getElementById(`protocol-date-display-${index}`).style.display = 'block';
        document.getElementById(`protocol-date-edit-${index}`).style.display = 'none';

        // Скрываем сообщения об ошибках
        document.getElementById(`protocol-number-error-${index}`).style.display = 'none';
        document.getElementById(`protocol-date-error-${index}`).style.display = 'none';

        // Меняем кнопки
        document.getElementById(`protocol-edit-btn-${index}`).style.display = 'inline';
        document.getElementById(`protocol-save-btn-${index}`).style.display = 'none';
        document.getElementById(`protocol-cancel-btn-${index}`).style.display = 'none';
    }

    // Удаление протокола
    function deleteProtocol(button) {
        const index = button.getAttribute('data-index');

        if (confirm('Вы уверены, что хотите удалить этот протокол?')) {
            // Помечаем как удаленный в массиве
            if (protocolsData[index]) {
                protocolsData[index].deleted = true;
            }

            // Скрываем строку таблицы
            document.getElementById(`protocol-row-${index}`).style.display = 'none';
        }
    }

    // Просмотр файла
    function viewFile(button) {
        const filename = button.getAttribute('data-filename');
        if (filename) {
            window.open(`/protocols/temp/${filename}`, '_blank');
        }
    }

    // Подготовка данных для формы подтверждения
    function prepareConfirmForm(event) {
        event.preventDefault();

        const form = document.getElementById('confirmForm');
        const numbers = [];
        const dates = [];
        const fileNames = [];

        // Собираем данные из не удаленных протоколов
        protocolsData.forEach((protocol, index) => {
            if (protocol && !protocol.deleted) {
                numbers.push(protocol.number);
                dates.push(protocol.date);
                fileNames.push(protocol.fileName || '');
            }
        });

        // Добавляем скрытые поля в форму
        numbers.forEach(number => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'protocolNumbers';
            input.value = number;
            form.appendChild(input);
        });

        dates.forEach(date => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'protocolDates';
            input.value = date;
            form.appendChild(input);
        });

        fileNames.forEach(fileName => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'fileName';
            input.value = fileName;
            form.appendChild(input);
        });

        // Отправляем форму
        form.submit();
    }

    // Подготовка данных для формы отмены
    function prepareCancelForm(event) {
        event.preventDefault();

        const form = document.getElementById('cancelForm');
        const fileNames = [];

        // Собираем имена файлов
        protocolsData.forEach(protocol => {
            if (protocol && protocol.fileName) {
                fileNames.push(protocol.fileName);
            }
        });

        // Добавляем скрытые поля в форму
        fileNames.forEach(fileName => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'fileName';
            input.value = fileName;
            form.appendChild(input);
        });

        // Отправляем форму
        form.submit();
    }

    // Валидация даты в формате дд.мм.гггг
    function isValidDate(dateString) {
        const regex = /^\d{2}\.\d{2}\.\d{4}$/;
        if (!regex.test(dateString)) {
            return false;
        }

        const parts = dateString.split('.');
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10);
        const year = parseInt(parts[2], 10);

        if (year < 1900 || year > 2100 || month === 0 || month > 12) {
            return false;
        }

        const monthLength = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

        // Проверка високосного года
        if (year % 400 === 0 || (year % 100 !== 0 && year % 4 === 0)) {
            monthLength[1] = 29;
        }

        return day > 0 && day <= monthLength[month - 1];
    }
</script>
</body>
</html>